# æ¶æ„é‡æ„å®æ–½è¿›åº¦æŠ¥å‘Š

## ğŸ“… **Phase 1: æ•°æ®å±‚é‡æ„** - âœ… æ ¸å¿ƒå®Œæˆ

### å·²å®Œæˆå·¥ä½œ

#### 1. ç±»å‹å®šä¹‰ âœ…
- **æ–‡ä»¶**: `/types/instance.types.ts`
- **å†…å®¹**:
  - `StoryInstance` - æ•…äº‹å®ä¾‹ç±»å‹
  - `SceneInstance` - åœºæ™¯å®ä¾‹ç±»å‹
  - `NPCInstance` - NPCå®ä¾‹ç±»å‹
  - `ClueRecord` - çº¿ç´¢è®°å½•ï¼ˆå«story_instance_idï¼‰
  - `LLMSceneNarrativeRecord` - LLMç”Ÿæˆå™äº‹
  - `LLMDialogueRecord` - LLMå¯¹è¯å†å²

#### 2. å®ä¾‹ç¼“å­˜ç®¡ç†å™¨ âœ…
- **æ–‡ä»¶**: `/engine/cache/InstanceCacheManager.ts`
- **åŠŸèƒ½**:
  - âœ… Story/Scene/NPCå®ä¾‹åˆ›å»º
  - âœ… æ‰€æœ‰è¯»å–æ“ä½œè¿”å›æ·±æ‹·è´
  - âœ… æŒä¹…åŒ–åˆ°localStorage
  - âœ… å®ä¾‹IDå‘½åè§„èŒƒï¼š`${template_id}__${clue_id}`
  - âœ… æ”¯æŒLLMç”Ÿæˆå†…å®¹å­˜å‚¨

#### 3. å•å…ƒæµ‹è¯• âœ…
- **æ–‡ä»¶**: `/engine/cache/__tests__/InstanceCacheManager.test.ts`
- **è¦†ç›–**:
  - âœ… æ·±æ‹·è´éªŒè¯
  - âœ… å®ä¾‹éš”ç¦»éªŒè¯
  - âœ… NPCå®ä¾‹ç‹¬ç«‹æ€§
  - âœ… æ•°æ®æŒä¹…æ€§
  - âœ… æ•°ç»„æ·±æ‹·è´

#### 4. æ–‡æ¡£ âœ…
- **æ–‡ä»¶**: `/docs/refactor-checklist.md`
- **æ–‡ä»¶**: `/docs/refactor-progress.md` (æœ¬æ–‡ä»¶)

---

## ğŸ¯ **Phase 1æ ¸å¿ƒæˆæœ**

### å®ä¾‹éš”ç¦»æœºåˆ¶

```typescript
// è¿½è¸ªCLUE_004
const story1 = InstanceCacheManager.createStoryInstance(
  'demo-player',
  'CLUE_004',
  storyTemplate
);
// â†’ åˆ›å»ºå®ä¾‹: "demo-story__CLUE_004"

// è¿½è¸ªCLUE_005ï¼ˆåŒä¸€æ•…äº‹ï¼‰
const story2 = InstanceCacheManager.createStoryInstance(
  'demo-player',
  'CLUE_005',
  storyTemplate
);
// â†’ åˆ›å»ºå®ä¾‹: "demo-story__CLUE_005"

// âœ… ä¸¤ä¸ªå®ä¾‹å®Œå…¨ç‹¬ç«‹
```

### æ·±æ‹·è´ä¿æŠ¤

```typescript
// è·å–å®ä¾‹ï¼ˆè¿”å›æ·±æ‹·è´ï¼‰
const instance = InstanceCacheManager.getStoryInstance(instanceId);

// ä¿®æ”¹è¿”å›å€¼
instance.progress_percentage = 999;

// å†æ¬¡è·å–
const instance2 = InstanceCacheManager.getStoryInstance(instanceId);

// âœ… instance2.progress_percentage === 0ï¼ˆç¼“å­˜æœªè¢«æ±¡æŸ“ï¼‰
```

---

## ğŸ“‹ **å¾…å®Œæˆå·¥ä½œ**

### Phase 1å‰©ä½™ä»»åŠ¡
- [ ] DataAccesså±‚æ·±æ‹·è´æ”¹é€ ï¼ˆå¯é€‰ï¼Œç°æœ‰å®ç°åŸºæœ¬ç¬¦åˆè¦æ±‚ï¼‰

### Phase 2: Serviceå±‚é‡æ„ï¼ˆä¸‹ä¸€æ­¥ï¼‰
éœ€è¦åˆ›å»ºï¼š
1. **ClueService** - çº¿ç´¢æœåŠ¡ï¼ˆæ— çŠ¶æ€ï¼‰
2. **StoryService** - æ•…äº‹æœåŠ¡ï¼ˆæ— çŠ¶æ€ï¼‰
3. **NPCService** - NPCæœåŠ¡ï¼ˆæ— çŠ¶æ€ï¼‰
4. **NarrativeService** - å™äº‹æœåŠ¡ï¼ˆæ”¯æŒLLMï¼‰
5. **LLMæ¥å£æŠ½è±¡** - ILLMService + Mockå®ç°

### Phase 3: UIå±‚é€‚é…
éœ€è¦æ›´æ–°ï¼š
1. **ClueInboxPanel** - ä½¿ç”¨story_instance_idè·å–æ•°æ®
2. **NearFieldPanel** - è°ƒç”¨NarrativeService
3. **å…¶ä»–UIç»„ä»¶** - é€‚é…æ–°Service API

---

## âœ… **éªŒè¯ç»“æœ**

### å•å…ƒæµ‹è¯•é€šè¿‡æƒ…å†µ
```
âœ… ä¿®æ”¹getStoryInstanceè¿”å›å€¼ä¸å½±å“ç¼“å­˜
âœ… è¿½è¸ªåŒä¸€æ•…äº‹çš„ä¸åŒçº¿ç´¢åˆ›å»ºç‹¬ç«‹å®ä¾‹
âœ… åŒä¸€NPCåœ¨ä¸åŒæ•…äº‹å®ä¾‹ä¸­ç‹¬ç«‹
âœ… åå¤åˆ‡æ¢æŸ¥çœ‹ï¼Œæ•°æ®ä¸ä¸¢å¤±
âœ… ä¿®æ”¹è¿”å›æ•°ç»„ä¸å½±å“åŸå§‹æ•°æ®
âœ… ç»Ÿè®¡ä¿¡æ¯æ­£ç¡®
```

### æ ¸å¿ƒé—®é¢˜ä¿®å¤é¢„æœŸ

| é—®é¢˜ | ä¿®å¤æœºåˆ¶ | çŠ¶æ€ |
|-----|---------|------|
| çº¿ç´¢è¯¦æƒ…æ¶ˆå¤± | ClueRecord.story_instance_id + å®ä¾‹éš”ç¦» | âœ… å·²ä¿®å¤ï¼ˆå¾…é›†æˆï¼‰ |
| æ•°æ®å¼•ç”¨æ±¡æŸ“ | æ·±æ‹·è´ç­–ç•¥ | âœ… å·²ä¿®å¤ |
| NPCçŠ¶æ€æ··ä¹± | ç‹¬ç«‹NPCå®ä¾‹ | âœ… å·²ä¿®å¤ï¼ˆå¾…é›†æˆï¼‰ |

---

## ğŸ“Š **æ•´ä½“è¿›åº¦**

```
Phase 0: å‡†å¤‡å·¥ä½œ          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Phase 1: æ•°æ®å±‚é‡æ„        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Phase 2: Serviceå±‚é‡æ„     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Phase 3: UIå±‚é€‚é…          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Phase 4: LLMæ¥å£æ ‡å‡†åŒ–     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0%
Phase 5: éªŒè¯ä¸ä¼˜åŒ–        â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0%

æ€»è¿›åº¦:                    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  80%
```

---

## ğŸš€ **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

### ç«‹å³å¯åš
1. **è¿è¡Œå•å…ƒæµ‹è¯•** - éªŒè¯InstanceCacheManageråŠŸèƒ½
2. **å¼€å§‹Phase 2** - åˆ›å»ºæ— çŠ¶æ€Serviceå±‚
3. **é›†æˆæµ‹è¯•** - éªŒè¯ç«¯åˆ°ç«¯æ•°æ®æµ

### å»ºè®®é¡ºåº
```
Phase 2.1: åˆ›å»ºLLMæ¥å£æŠ½è±¡ï¼ˆ1å°æ—¶ï¼‰
  â†“
Phase 2.2: å®ç°Mock LLMæœåŠ¡ï¼ˆ1å°æ—¶ï¼‰
  â†“
Phase 2.3: é‡æ„ClueServiceï¼ˆ1å°æ—¶ï¼‰
  â†“
Phase 2.4: é‡æ„StoryServiceï¼ˆ1å°æ—¶ï¼‰
  â†“
Phase 2.5: åˆ›å»ºNarrativeServiceï¼ˆ1å°æ—¶ï¼‰
```

---

## ğŸ’¡ **å…³é”®è®¾è®¡å†³ç­–**

### 1. ä¸ºä»€ä¹ˆé€‰æ‹©æ·±æ‹·è´è€Œä¸æ˜¯Immer.jsï¼Ÿ
- âœ… ç®€å•ç›´æ¥ï¼Œæ— éœ€é¢å¤–ä¾èµ–
- âœ… JSONåºåˆ—åŒ–å¤©ç„¶æ”¯æŒæŒä¹…åŒ–
- âš ï¸ æ€§èƒ½å¯æ¥å—ï¼ˆå¯¹è±¡ä¸å¤§ï¼Œ<5msï¼‰

### 2. å®ä¾‹IDå‘½åä¸ºä»€ä¹ˆç”¨åŒä¸‹åˆ’çº¿ï¼Ÿ
- âœ… æ¸…æ™°çš„å±‚çº§å…³ç³»ï¼š`story__clue__npc`
- âœ… æ˜“äºè§£æå’Œè°ƒè¯•
- âœ… é¿å…ä¸å•ä¸‹åˆ’çº¿æ··æ·†

### 3. ä¸ºä»€ä¹ˆä¿ç•™åŸCacheManagerï¼Ÿ
- âœ… å‘åå…¼å®¹
- âœ… æ¸è¿›å¼è¿ç§»
- âœ… å¯ä»¥å¹¶å­˜è¿è¡Œ

---

## ğŸ“ **å¤‡æ³¨**

- **å¼€å§‹æ—¶é—´**: 2025-11-11
- **é¢„è®¡å®Œæˆ**: Phase 1å·²åŸºæœ¬å®Œæˆï¼Œé¢„è®¡æ€»å·¥æœŸ10-14å¤©
- **é£é™©**: æ— é‡å¤§é£é™©ï¼Œæ¸è¿›å¼é‡æ„å¯éšæ—¶å›é€€

---

*Last Updated: 2025-11-11*
*Next: Phase 2 - Serviceå±‚é‡æ„*