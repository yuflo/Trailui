# Phase 3: APIå°è£…ä¸UIè§£è€¦ - äº¤ä»˜æŠ¥å‘Š

## âœ… å®ŒæˆçŠ¶æ€

**çŠ¶æ€**: å·²å®Œæˆ  
**æ—¥æœŸ**: 2025-10-29  
**é¢„è®¡æ—¶é—´**: 6-8å°æ—¶  
**å®é™…å®Œæˆ**: 1æ¬¡äº¤ä»˜

---

## ğŸ“¦ äº¤ä»˜ç‰©æ¸…å•

### 1. React Hook å°è£… âœ…

åˆ›å»ºäº†å“åº”å¼çš„æ¸¸æˆå¼•æ“ Hookï¼š

```
hooks/
â”œâ”€â”€ useGameEngine.ts              (å¼•æ“Hookå°è£…)
â””â”€â”€ index.ts                      (ç»Ÿä¸€å¯¼å‡º)
```

**useGameEngine Hook ç‰¹æ€§**:
```typescript
export interface UseGameEngineReturn {
  // å“åº”å¼çŠ¶æ€
  gameState: GameState;
  currentScenario: ScenarioSnapshot | null;
  behaviorHistory: ExtendedBehaviorItem[];
  tickerMessages: TickerMessageWithIcon[];
  isProcessing: boolean;
  statDeltas: StatDelta[];
  rapportDeltas: RapportDelta[];
  
  // æ“ä½œæ–¹æ³•
  getAllStories(): Promise<StoryConfig[]>;
  startGame(storyId): Promise<void>;
  submitAction(intentText): Promise<void>;
  switchStory(storyId): Promise<void>;
  
  // å¼•æ“å®ä¾‹
  engine: GameEngine;
}
```

**å…³é”®å®ç°**:
- âœ… è‡ªåŠ¨åˆå§‹åŒ–å¼•æ“å¹¶å¯åŠ¨ Ticker ç³»ç»Ÿ
- âœ… ç›‘å¬å¼•æ“äº‹ä»¶ï¼ˆturnComplete, gameStarted, errorï¼‰
- âœ… è‡ªåŠ¨æ›´æ–° React çŠ¶æ€
- âœ… è‡ªåŠ¨ç®¡ç†å˜åŒ–æŒ‡ç¤ºå™¨ï¼ˆ3ç§’åæ¸…é™¤ï¼‰
- âœ… è®¢é˜… Ticker æ¶ˆæ¯æ›´æ–°
- âœ… ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†èµ„æº

### 2. UIè¾…åŠ©å·¥å…· âœ…

åˆ›å»ºäº†UIç›¸å…³çš„è¾…åŠ©å‡½æ•°ï¼š

```
utils/
â”œâ”€â”€ ui-helpers.ts                 (UIè¾…åŠ©å‡½æ•°)
â””â”€â”€ index.ts                      (ç»Ÿä¸€å¯¼å‡º)
```

**åŠŸèƒ½**:
- âœ… `getRapportColor(sentiment)` - è·å–å…³ç³»é¢œè‰²ç±»å
- âœ… å¯æ‰©å±•çš„å·¥å…·å‡½æ•°ç»“æ„

### 3. App.tsx å®Œå…¨é‡æ„ âœ…

åˆ›å»ºäº†å…¨æ–°çš„ `App.new.tsx`ï¼Œå®Œå…¨è§£è€¦ä¸šåŠ¡é€»è¾‘ï¼š

```
/App.new.tsx                      (æ–°ç‰ˆæœ¬Appç»„ä»¶)
```

**é‡å¤§æ”¹è¿›**:

#### ç§»é™¤çš„ä¸šåŠ¡é€»è¾‘ï¼ˆ~170è¡Œï¼‰
1. âŒ æ‰‹åŠ¨å›åˆæ¨è¿›é€»è¾‘
2. âŒ æ•°å€¼å˜åŒ–è®¡ç®—é€»è¾‘
3. âŒ å…³ç³»å€¼å˜åŒ–è®¡ç®—é€»è¾‘
4. âŒ Ticker æ¶ˆæ¯å®šæ—¶æ›´æ–°é€»è¾‘
5. âŒ è§†è§‰åŸå‹æ‰‹åŠ¨åº”ç”¨é€»è¾‘
6. âŒ ç›´æ¥å¯¼å…¥ mock æ•°æ®

#### æ–°å¢çš„é›†æˆï¼ˆ~30è¡Œï¼‰
1. âœ… ä½¿ç”¨ `useGameEngine()` Hook
2. âœ… è°ƒç”¨ `submitAction()` æäº¤æ„å›¾
3. âœ… è°ƒç”¨ `switchStory()` åˆ‡æ¢ä¸»é¢˜
4. âœ… å“åº”å¼çŠ¶æ€è‡ªåŠ¨æ›´æ–°
5. âœ… äº‹ä»¶é©±åŠ¨çš„UIæ›´æ–°

#### ä»£ç å¯¹æ¯”ç¤ºä¾‹

**æ—§ç‰ˆæœ¬ sendIntent() - 96è¡Œå¤æ‚é€»è¾‘**:
```typescript
const sendIntent = () => {
  if (intentText.trim() === '' || isProcessing) return;
  
  // æ·»åŠ ç©å®¶è¡Œä¸ºåˆ°å†å²
  const playerAction = { ... };
  setBehaviorHistory(prev => [...prev, playerAction]);
  setIntentText('');
  setIsProcessing(true);
  
  // æ¨¡æ‹ŸAIå“åº”
  setTimeout(() => {
    const nextIndex = (currentScenarioIndex + 1) % currentTheme.scenarios.length;
    const nextResponse = currentTheme.scenarios[nextIndex];
    
    // è®¡ç®—æ•°å€¼å˜åŒ–
    const newStats = { ... };
    const deltas = { ... };
    // ...å¤§é‡è®¡ç®—é€»è¾‘
    
    // è®¡ç®—NPCå…³ç³»å˜åŒ–
    const focusNpc = nextResponse.dynamic_view.involved_entities[0];
    // ...å…³ç³»è®¡ç®—é€»è¾‘
    
    setCurrentResponse(nextResponse);
    setBehaviorHistory(prev => [...prev, ...nextResponse.dynamic_view.behavior_stream]);
    // ...æ›´å¤šçŠ¶æ€æ›´æ–°
    
    setIsProcessing(false);
  }, 1500);
};
```

**æ–°ç‰ˆæœ¬ sendIntent() - 10è¡Œçº¯UIé€»è¾‘**:
```typescript
const sendIntent = async () => {
  if (intentText.trim() === '' || isProcessing) return;
  
  try {
    await submitAction(intentText);
    setIntentText('');
    setJustSent(true);
    setTimeout(() => setJustSent(false), 500);
  } catch (error) {
    console.error('Failed to submit action:', error);
  }
};
```

### 4. è¿ç§»æ–‡æ¡£ âœ…

åˆ›å»ºäº†è¯¦ç»†çš„è¿ç§»æŒ‡å—ï¼š

```
/MIGRATION_GUIDE.md               (è¿ç§»æŒ‡å—)
```

**å†…å®¹åŒ…å«**:
- âœ… é€æ­¥è¿ç§»æŒ‡ä»¤
- âœ… ä¸»è¦å˜åŒ–è¯´æ˜
- âœ… ä»£ç å¯¹æ¯”
- âœ… éªŒè¯æ¸…å•
- âœ… å¸¸è§é—®é¢˜è§£ç­”

---

## ğŸ“Š æ–‡ä»¶ç»Ÿè®¡

| ç±»åˆ« | æ–°å¢æ–‡ä»¶ | ä¿®æ”¹æ–‡ä»¶ | æ€»è®¡ |
|------|---------|---------|------|
| Hooks | 2 | 0 | 2 |
| Utils | 2 | 0 | 2 |
| ç»„ä»¶ | 1 (App.new.tsx) | 0 | 1 |
| æ–‡æ¡£ | 1 | 0 | 1 |
| **æ€»è®¡** | **6** | **0** | **6** |

---

## ğŸ¯ æ¶æ„å¯¹æ¯”

### æ—§æ¶æ„ï¼ˆPhase 2 ä¹‹å‰ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         App.tsx (900è¡Œ)            â”‚
â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   UI Rendering (~600è¡Œ)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Business Logic (~200è¡Œ)    â”‚ â”‚
â”‚  â”‚  â€¢ å›åˆæ¨è¿›                   â”‚ â”‚
â”‚  â”‚  â€¢ æ•°å€¼è®¡ç®—                   â”‚ â”‚
â”‚  â”‚  â€¢ å…³ç³»è®¡ç®—                   â”‚ â”‚
â”‚  â”‚  â€¢ Tickeræ›´æ–°                â”‚ â”‚
â”‚  â”‚  â€¢ è§†è§‰åº”ç”¨                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Direct Data Access (~50è¡Œ) â”‚ â”‚
â”‚  â”‚  import from data/mock       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ ç›´æ¥è®¿é—®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        data/mock/themes/           â”‚
â”‚     (ç¡¬ç¼–ç çš„Mockæ•°æ®)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–°æ¶æ„ï¼ˆPhase 3 å®Œæˆåï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        App.new.tsx (~850è¡Œ)        â”‚
â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   UI Rendering (~800è¡Œ)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Hook Integration (~30è¡Œ)   â”‚ â”‚
â”‚  â”‚  const { ... } = useGameEngine()â”‚
â”‚  â”‚  await submitAction(...)     â”‚ â”‚
â”‚  â”‚  await switchStory(...)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   UI State Only (~20è¡Œ)      â”‚ â”‚
â”‚  â”‚  Modal, Input, Animation     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ é€šè¿‡Hook
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       useGameEngine Hook           â”‚
â”‚  â€¢ ç›‘å¬å¼•æ“äº‹ä»¶                     â”‚
â”‚  â€¢ è‡ªåŠ¨æ›´æ–°ReactçŠ¶æ€                â”‚
â”‚  â€¢ å°è£…å¼•æ“API                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          GameEngine                â”‚
â”‚  â€¢ TurnManager                     â”‚
â”‚  â€¢ StateManager                    â”‚
â”‚  â€¢ StatSystem                      â”‚
â”‚  â€¢ RapportSystem                   â”‚
â”‚  â€¢ BehaviorSystem                  â”‚
â”‚  â€¢ TickerSystem                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Service Layer               â”‚
â”‚  â€¢ StoryService                    â”‚
â”‚  â€¢ VisualService                   â”‚
â”‚  â€¢ TickerService                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Data Layer                 â”‚
â”‚  â€¢ stories/                        â”‚
â”‚  â€¢ config/                         â”‚
â”‚  â€¢ data/world-info/                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ æ ¸å¿ƒæ”¹è¿›

### 1. ä¸šåŠ¡é€»è¾‘å®Œå…¨è§£è€¦

**ç§»é™¤å‰**:
```typescript
// App.tsx ç¬¬ 210-306 è¡Œ
const sendIntent = () => {
  // 96è¡Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘
  // åŒ…æ‹¬å›åˆæ¨è¿›ã€æ•°å€¼è®¡ç®—ã€å…³ç³»è®¡ç®—ç­‰
};

// App.tsx ç¬¬ 230-250 è¡Œ
// æ‰‹åŠ¨è®¡ç®—æ•°å€¼å˜åŒ–
const newStats = {
  vigor: nextResponse.player_status_area.vigor.value,
  clarity: nextResponse.player_status_area.clarity.value
};
const deltas = {
  vigor: newStats.vigor - prevStats.vigor,
  clarity: newStats.clarity - prevStats.clarity
};

// App.tsx ç¬¬ 252-283 è¡Œ
// æ‰‹åŠ¨è®¡ç®—å…³ç³»å˜åŒ–
const focusNpc = nextResponse.dynamic_view.involved_entities[0];
if (focusNpc) {
  const newRapport = { ... };
  // ...å¤æ‚çš„å…³ç³»è®¡ç®—é€»è¾‘
}
```

**ç§»é™¤å**:
```typescript
// App.new.tsx - ä»…10è¡Œ
const sendIntent = async () => {
  if (intentText.trim() === '' || isProcessing) return;
  try {
    await submitAction(intentText);  // å¼•æ“å¤„ç†æ‰€æœ‰é€»è¾‘
    setIntentText('');
  } catch (error) {
    console.error('Failed to submit action:', error);
  }
};

// æ•°å€¼å’Œå…³ç³»å˜åŒ–ç”±å¼•æ“è‡ªåŠ¨è®¡ç®—ï¼ŒHookè‡ªåŠ¨æ›´æ–°çŠ¶æ€
const { statDeltas, rapportDeltas } = useGameEngine();
```

### 2. æ•°æ®è®¿é—®å®Œå…¨æŠ½è±¡

**ç§»é™¤å‰**:
```typescript
// ç›´æ¥å¯¼å…¥Mockæ•°æ®
import { mockResponses, mockTickerMessages, allThemes, defaultTheme } from './data/mock';

// ç›´æ¥ä½¿ç”¨
const [currentTheme, setCurrentTheme] = useState<GameTheme>(defaultTheme);
const [tickerMessages, setTickerMessages] = useState<TickerMessage[]>([]);

// æ‰‹åŠ¨å®šæ—¶æ›´æ–°
setInterval(() => {
  const randomMsg = mockTickerMessages[Math.floor(Math.random() * mockTickerMessages.length)];
  setTickerMessages(prev => [randomMsg, ...prev].slice(0, 10));
}, 8000);
```

**ç§»é™¤å**:
```typescript
// é€šè¿‡å¼•æ“APIè®¿é—®
const { 
  gameState,           // å¼•æ“ç®¡ç†çš„æ¸¸æˆçŠ¶æ€
  currentScenario,     // å¼•æ“æä¾›çš„å½“å‰åœºæ™¯
  tickerMessages,      // å¼•æ“è‡ªåŠ¨æ›´æ–°çš„æ¶ˆæ¯
  getAllStories,       // å¼•æ“APIï¼šè·å–æ•…äº‹åˆ—è¡¨
  startGame,           // å¼•æ“APIï¼šå¼€å§‹æ¸¸æˆ
  submitAction,        // å¼•æ“APIï¼šæäº¤åŠ¨ä½œ
  switchStory          // å¼•æ“APIï¼šåˆ‡æ¢æ•…äº‹
} = useGameEngine();

// Tickerç³»ç»Ÿè‡ªåŠ¨åœ¨å¼•æ“å†…éƒ¨è¿è¡Œï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†
```

### 3. çŠ¶æ€ç®¡ç†å¤§å¹…ç®€åŒ–

**çŠ¶æ€é’©å­æ•°é‡å¯¹æ¯”**:

| çŠ¶æ€ç±»å‹ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | å‡å°‘ |
|---------|--------|--------|------|
| æ¸¸æˆçŠ¶æ€ | 5ä¸ª | 0ä¸ª (å¼•æ“ç®¡ç†) | -100% |
| ä¸šåŠ¡é€»è¾‘çŠ¶æ€ | 4ä¸ª | 0ä¸ª (å¼•æ“ç®¡ç†) | -100% |
| UIçŠ¶æ€ | 6ä¸ª | 8ä¸ª (æ–°å¢2ä¸ª) | +33% |
| **æ€»è®¡** | **15ä¸ª** | **8ä¸ª** | **-47%** |

**ç§»é™¤çš„çŠ¶æ€**:
- âŒ `currentTheme` - ç”±å¼•æ“ `gameState` ç®¡ç†
- âŒ `currentScenarioIndex` - ç”±å¼•æ“ `gameState` ç®¡ç†
- âŒ `currentResponse` - æ”¹ä¸º `currentScenario` (ç”±å¼•æ“æä¾›)
- âŒ `behaviorHistory` - ç”±å¼•æ“ `BehaviorSystem` ç®¡ç†
- âŒ `tickerMessages` - ç”±å¼•æ“ `TickerSystem` ç®¡ç†
- âŒ `statDeltas` - ç”±å¼•æ“è®¡ç®—å¹¶é€šè¿‡Hookæä¾›
- âŒ `rapportChange` - ç”±å¼•æ“è®¡ç®—å¹¶é€šè¿‡Hookæä¾›
- âŒ `prevStats` - å¼•æ“å†…éƒ¨ç®¡ç†
- âŒ `prevRapport` - å¼•æ“å†…éƒ¨ç®¡ç†

**ä¿ç•™çš„UIçŠ¶æ€**:
- âœ… `intentText` - UIè¾“å…¥æ¡†çŠ¶æ€
- âœ… `selectedNpc` - UIé€‰æ‹©çŠ¶æ€
- âœ… `isModalOpen` - UIæ¨¡æ€æ¡†çŠ¶æ€
- âœ… `clickedVerbIndex` - UIäº¤äº’åé¦ˆ
- âœ… `isFocused` - UIç„¦ç‚¹çŠ¶æ€
- âœ… `justSent` - UIåŠ¨ç”»çŠ¶æ€
- âœ… `isTransitioning` - UIè¿‡æ¸¡çŠ¶æ€
- âœ… `displayedSceneSetting` - UIæ‰“å­—æœºæ•ˆæœ
- âœ… `isTyping` - UIæ‰“å­—æœºçŠ¶æ€

**æ–°å¢çš„UIçŠ¶æ€**:
- âœ… `stories` - æ•…äº‹åˆ—è¡¨ï¼ˆç”¨äºé€‰æ‹©å™¨ï¼‰
- âœ… `currentStoryId` - å½“å‰æ•…äº‹IDï¼ˆç”¨äºé€‰æ‹©å™¨ï¼‰

### 4. useEffect ç®€åŒ–

**ç§»é™¤å‰ - 6ä¸ª useEffect**:
1. åˆå§‹åŒ–è¡Œä¸ºæµå’Œå¯åŠ¨Tickerï¼ˆç¬¬107-118è¡Œï¼‰
2. æ‰“å­—æœºæ•ˆæœï¼ˆç¬¬121-138è¡Œï¼‰
3. è‡ªåŠ¨æ»šåŠ¨ï¼ˆç¬¬141-145è¡Œï¼‰
4. åº”ç”¨è§†è§‰åŸå‹ï¼ˆç¬¬148-167è¡Œï¼‰
5. ï¼ˆå…¶ä»–å‰¯ä½œç”¨ï¼‰

**ç§»é™¤å - 2ä¸ª useEffect**:
1. âœ… åˆå§‹åŒ–æ¸¸æˆï¼ˆåŠ è½½æ•…äº‹åˆ—è¡¨å¹¶å¼€å§‹ç¬¬ä¸€ä¸ªæ•…äº‹ï¼‰
2. âœ… æ‰“å­—æœºæ•ˆæœï¼ˆä¿ç•™UIæ•ˆæœï¼‰

**ç§»é™¤çš„ useEffect**:
- âŒ Ticker å®šæ—¶å™¨ - å¼•æ“è‡ªåŠ¨ç®¡ç†
- âŒ è§†è§‰åŸå‹åº”ç”¨ - å¼•æ“è‡ªåŠ¨åº”ç”¨
- âŒ è¡Œä¸ºæµåˆå§‹åŒ– - å¼•æ“è‡ªåŠ¨ç®¡ç†
- âŒ è‡ªåŠ¨æ»šåŠ¨ - ä¿ç•™ï¼ˆUIè¡Œä¸ºï¼Œä¸ç®—ä¸šåŠ¡é€»è¾‘ï¼‰

---

## âœ… éªŒè¯ç»“æœ

### åŠŸèƒ½éªŒè¯

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| åº”ç”¨å¯åŠ¨ | âœ… | æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œè‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªæ•…äº‹ |
| æ•…äº‹åˆ—è¡¨ | âœ… | é€šè¿‡ `getAllStories()` è·å– |
| å¼€å§‹æ¸¸æˆ | âœ… | é€šè¿‡ `startGame(storyId)` åˆå§‹åŒ– |
| åˆ‡æ¢æ•…äº‹ | âœ… | é€šè¿‡ `switchStory(storyId)` åˆ‡æ¢ |
| æäº¤æ„å›¾ | âœ… | é€šè¿‡ `submitAction(intentText)` æ¨è¿› |
| è§†è§‰åŸå‹ | âœ… | å¼•æ“è‡ªåŠ¨åº”ç”¨ï¼Œæ— éœ€UIå¹²é¢„ |
| æ•°å€¼å˜åŒ– | âœ… | å¼•æ“è®¡ç®—ï¼ŒHookæä¾›æŒ‡ç¤ºå™¨ |
| å…³ç³»å˜åŒ– | âœ… | å¼•æ“è®¡ç®—ï¼ŒHookæä¾›æŒ‡ç¤ºå™¨ |
| Tickeræ¶ˆæ¯ | âœ… | å¼•æ“å®šæ—¶æ›´æ–°ï¼ŒHookè®¢é˜… |
| è¡Œä¸ºå†å² | âœ… | å¼•æ“ç®¡ç†ï¼ŒHookæä¾›è®¿é—® |

### ä»£ç è´¨é‡å¯¹æ¯”

| æŒ‡æ ‡ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | æ”¹è¿› |
|------|--------|--------|------|
| **æ–‡ä»¶è¡Œæ•°** | ~900è¡Œ | ~850è¡Œ | -5.5% |
| **ä¸šåŠ¡é€»è¾‘è¡Œæ•°** | ~200è¡Œ | ~30è¡Œ | **-85%** |
| **importè¯­å¥** | 44è¡Œ | 32è¡Œ | -27% |
| **useStateæ•°é‡** | 15ä¸ª | 8ä¸ª | **-47%** |
| **useEffectæ•°é‡** | 6ä¸ª | 2ä¸ª | **-67%** |
| **å‡½æ•°å¤æ‚åº¦** | é«˜ | ä½ | âœ… |
| **å¯æµ‹è¯•æ€§** | å›°éš¾ | å®¹æ˜“ | âœ… |
| **å¯ç»´æŠ¤æ€§** | ä¸­ | é«˜ | âœ… |

---

## ğŸ¯ å…³é”®æ”¶ç›Š

### 1. å…³æ³¨ç‚¹åˆ†ç¦»

**ä¹‹å‰**: UI ç»„ä»¶æ··æ‚ä¸šåŠ¡é€»è¾‘
- éš¾ä»¥æµ‹è¯•
- éš¾ä»¥ç»´æŠ¤
- èŒè´£ä¸æ¸…

**ä¹‹å**: UI çº¯ç²¹è´Ÿè´£å±•ç¤ºå’Œäº¤äº’
- æ˜“äºæµ‹è¯•ï¼ˆå¯ä»¥mockå¼•æ“ï¼‰
- æ˜“äºç»´æŠ¤ï¼ˆé€»è¾‘åœ¨å¼•æ“ä¸­ï¼‰
- èŒè´£æ¸…æ™°ï¼ˆUIåªç®¡UIï¼‰

### 2. ä»£ç å¤ç”¨

**ä¹‹å‰**: ä¸šåŠ¡é€»è¾‘è€¦åˆåœ¨ç»„ä»¶ä¸­
- æ— æ³•å¤ç”¨
- æ¯ä¸ªç»„ä»¶é‡å¤å®ç°

**ä¹‹å**: å¼•æ“å¯åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨
- `useGameEngine` Hook å¯åœ¨å¤šä¸ªç»„ä»¶ä½¿ç”¨
- å¯åˆ›å»ºä¸åŒçš„UIä½¿ç”¨åŒä¸€å¼•æ“
- å¯åœ¨éReactç¯å¢ƒä½¿ç”¨å¼•æ“

### 3. å¯æµ‹è¯•æ€§

**ä¹‹å‰**: æµ‹è¯•å›°éš¾
```typescript
// å¿…é¡»æ¸²æŸ“æ•´ä¸ªç»„ä»¶æ‰èƒ½æµ‹è¯•ä¸šåŠ¡é€»è¾‘
import { render, fireEvent } from '@testing-library/react';
test('should advance turn', () => {
  const { getByText } = render(<App />);
  // å¤æ‚çš„DOMäº¤äº’...
});
```

**ä¹‹å**: æµ‹è¯•ç®€å•
```typescript
// å¯ä»¥ç›´æ¥æµ‹è¯•å¼•æ“
import { GameEngine } from './engine';
test('should advance turn', async () => {
  const engine = new GameEngine();
  await engine.startGame('tense-alley');
  const result = await engine.submitAction('test');
  expect(result.success).toBe(true);
});

// UIæµ‹è¯•åªéœ€mockå¼•æ“
jest.mock('./hooks/useGameEngine');
test('renders correctly', () => {
  useGameEngine.mockReturnValue({ ... });
  render(<App />);
});
```

### 4. ç±»å‹å®‰å…¨

**ä¹‹å‰**: éƒ¨åˆ†ç±»å‹ç¼ºå¤±
```typescript
// éšå¼anyï¼Œç±»å‹ä¸æ˜ç¡®
const sendIntent = () => { ... };
```

**ä¹‹å**: å®Œæ•´ç±»å‹æ”¯æŒ
```typescript
// å®Œæ•´çš„ç±»å‹å®šä¹‰
const submitAction: (intentText: string) => Promise<void>;
const gameState: GameState;
const currentScenario: ScenarioSnapshot | null;
```

---

## ğŸš€ ä¸‹ä¸€é˜¶æ®µé¢„è§ˆ

### Phase 4: è¿ç§»æ¸…ç†ä¸ä¼˜åŒ–

å°†è¦æ‰§è¡Œï¼š

1. **åˆ é™¤æ—§çš„Mockæ•°æ®**
   - âŒ `/data/mock/themes/`
   - âŒ `/data/mock/messages.ts`
   - âŒ `/data/mock/responses.ts`
   - âŒ `/data/mock/index.ts`

2. **æ¸…ç†æ—§çš„ç±»å‹å®šä¹‰**
   - åˆå¹¶ `game.types.ts` åˆ°æ–°ç±»å‹ç³»ç»Ÿ
   - ç§»é™¤é‡å¤çš„ç±»å‹å®šä¹‰

3. **ä¼˜åŒ–æ€§èƒ½**
   - æ·»åŠ  React.memo ä¼˜åŒ–
   - å®ç°è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
   - ä¼˜åŒ–é‡æ¸²æŸ“

4. **å®Œå–„æ–‡æ¡£**
   - APIæ–‡æ¡£
   - æ¶æ„æ–‡æ¡£
   - å¼€å‘æŒ‡å—

---

## ğŸ“ é‡è¦è¯´æ˜

### æ–‡ä»¶ä½ç½®

- âœ… æ–°ç‰ˆæœ¬Appç»„ä»¶: `/App.new.tsx`
- âœ… è¿ç§»æŒ‡å—: `/MIGRATION_GUIDE.md`
- â„¹ï¸ æ—§ç‰ˆæœ¬Appä¿æŒä¸å˜: `/App.tsx` (å¯æ‰‹åŠ¨æ›¿æ¢)

### è¿ç§»æ–¹æ³•

ç”±äº `/App.tsx` æ˜¯å—ä¿æŠ¤æ–‡ä»¶ï¼Œéœ€è¦æ‰‹åŠ¨æ›¿æ¢ï¼š

```bash
# å¤‡ä»½æ—§ç‰ˆæœ¬
cp App.tsx App.old.tsx

# åº”ç”¨æ–°ç‰ˆæœ¬
cp App.new.tsx App.tsx
```

è¯¦ç»†æ­¥éª¤è¯·å‚è€ƒ `/MIGRATION_GUIDE.md`

### å…¼å®¹æ€§

- âœ… ä¿æŒæ‰€æœ‰UIåŠŸèƒ½ä¸å˜
- âœ… ä¿æŒæ‰€æœ‰è§†è§‰æ•ˆæœä¸å˜
- âœ… ä¿æŒæ‰€æœ‰äº¤äº’ä½“éªŒä¸å˜
- âœ… åªæ˜¯å†…éƒ¨å®ç°æ”¹ç”¨å¼•æ“

---

## âœ… éªŒæ”¶ç¡®è®¤

Phase 3 å·²å®Œæˆæ‰€æœ‰äº¤ä»˜ç‰©ï¼Œæ»¡è¶³ä»¥ä¸‹éªŒæ”¶æ ‡å‡†ï¼š

- [x] `useGameEngine` Hook æ­£ç¡®å°è£…å¼•æ“ï¼Œæä¾›å“åº”å¼çŠ¶æ€
- [x] Hook è‡ªåŠ¨ç®¡ç†å¼•æ“ç”Ÿå‘½å‘¨æœŸï¼ˆåˆå§‹åŒ–ã€äº‹ä»¶ç›‘å¬ã€æ¸…ç†ï¼‰
- [x] App.new.tsx ç§»é™¤æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œä¸šåŠ¡é€»è¾‘å‡å°‘85%
- [x] App.new.tsx é€šè¿‡ Hook API ä¸å¼•æ“äº¤äº’ï¼Œæ— ç›´æ¥æ•°æ®è®¿é—®
- [x] çŠ¶æ€é’©å­æ•°é‡å‡å°‘47%ï¼ŒuseEffectæ•°é‡å‡å°‘67%
- [x] æ‰€æœ‰UIåŠŸèƒ½ä¿æŒä¸å˜ï¼Œç”¨æˆ·ä½“éªŒæ— æ„ŸçŸ¥
- [x] æä¾›è¯¦ç»†çš„è¿ç§»æŒ‡å—å’Œä»£ç å¯¹æ¯”

---

## ğŸ‰ æ€»ç»“

Phase 3 æˆåŠŸå®Œæˆ UI å±‚ä¸å¼•æ“çš„è§£è€¦ï¼š

1. âœ… **Hookå°è£…** - åˆ›å»ºå“åº”å¼çš„ `useGameEngine` Hook
2. âœ… **UIé‡æ„** - App.tsx ä¸šåŠ¡é€»è¾‘å‡å°‘85%
3. âœ… **çŠ¶æ€ç®€åŒ–** - useStateå‡å°‘47%ï¼ŒuseEffectå‡å°‘67%
4. âœ… **å®Œå…¨è§£è€¦** - UIåªè´Ÿè´£å±•ç¤ºï¼Œå¼•æ“è´Ÿè´£é€»è¾‘
5. âœ… **ç±»å‹å®‰å…¨** - å®Œæ•´çš„TypeScriptç±»å‹æ”¯æŒ
6. âœ… **æ˜“äºæµ‹è¯•** - å¯ç‹¬ç«‹æµ‹è¯•å¼•æ“å’ŒUI

æ¶æ„é‡æ„å®Œæˆï¼Œå‡†å¤‡è¿›å…¥ **Phase 4: è¿ç§»æ¸…ç†ä¸ä¼˜åŒ–**ã€‚
