# ä¸‰å±‚æ•°æ®å¯¹æ¯”ï¼šData Access vs Service Mock vs Cache

## ğŸ¯ **ä¸‰å±‚æ•°æ®çš„æœ¬è´¨åŒºåˆ«**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ¨ æ¸¸æˆè®¾è®¡å¸ˆçš„å·¥ä½œ                           â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Data Access Layer (é™æ€æ¨¡æ¿æ•°æ®)                â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  æ–‡ä»¶ï¼š/data/hong-kong/demo-story-map.data.ts              â”‚ â”‚
â”‚  â”‚  å®ç°ï¼šStoryDataAccessMock.getStoryById()                  â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  æ•°æ®ç¤ºä¾‹ï¼š                                                 â”‚ â”‚
â”‚  â”‚  {                                                         â”‚ â”‚
â”‚  â”‚    story_id: 'story-hk-001',                               â”‚ â”‚
â”‚  â”‚    title: 'éœ“è™¹è¿·é›¾',                                       â”‚ â”‚
â”‚  â”‚    scenes: ['scene-a', 'scene-b', 'scene-c'],             â”‚ â”‚
â”‚  â”‚    scenes: {                                               â”‚ â”‚
â”‚  â”‚      'scene-a': {                                          â”‚ â”‚
â”‚  â”‚        title: 'èµ›åšé…’å§',                                   â”‚ â”‚
â”‚  â”‚        location: 'ç¬¬ä¸ƒåŒº',                                  â”‚ â”‚
â”‚  â”‚        npc_ids: ['npc-broker', 'npc-bartender']           â”‚ â”‚
â”‚  â”‚      }                                                     â”‚ â”‚
â”‚  â”‚    }                                                       â”‚ â”‚
â”‚  â”‚  }                                                         â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  ç‰¹ç‚¹ï¼š                                                     â”‚ â”‚
â”‚  â”‚  â€¢ æ¸¸æˆå…³å¡è®¾è®¡                                            â”‚ â”‚
â”‚  â”‚  â€¢ æ‰€æœ‰ç©å®¶å…±äº«                                            â”‚ â”‚
â”‚  â”‚  â€¢ æ¸¸æˆæ›´æ–°æ‰å˜åŒ–                                          â”‚ â”‚
â”‚  â”‚  â€¢ æ¥æºï¼šJSON / CMS / ç¼–è¾‘å™¨                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ¤– AI ç”Ÿæˆçš„å†…å®¹                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Service Mock Data (LLM æ¨¡æ‹Ÿæ•°æ®)                   â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  æ–‡ä»¶ï¼š/engine/services/business/MockDataProvider.ts       â”‚ â”‚
â”‚  â”‚  å®ç°ï¼šMockSceneProvider.generateSceneNarrative()          â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  æ•°æ®ç¤ºä¾‹ï¼š                                                 â”‚ â”‚
â”‚  â”‚  generateSceneNarrative('scene-a') è¿”å›ï¼š                  â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  "ä½ æ¨å¼€åšé‡çš„é‡‘å±é—¨ï¼Œèµ°è¿›è¿™ä¸ªè¢«éœ“è™¹ç¯ç…§äº®çš„åœ°ä¸‹ä¸–ç•Œã€‚      â”‚ â”‚
â”‚  â”‚   é…’å§é‡ŒçƒŸé›¾ç¼­ç»•ï¼Œå…¨æ¯æŠ•å½±åœ¨ç©ºæ°”ä¸­æ‰­æ›²å˜å½¢ã€‚               â”‚ â”‚
â”‚  â”‚   å§å°åçš„è°ƒé…’å¸ˆæœºæ¢°åœ°æ“¦æ‹­ç€æ¯å­ï¼Œå¶å°”æŠ¬çœ¼æ‰«è§†è¿›æ¥çš„å®¢äººã€‚ â”‚ â”‚
â”‚  â”‚   è§’è½é‡Œçš„å‡ ä¸ªèº«å½±ç”¨æ”¹è£…è¿‡çš„ç¥ç»æ¥å£ä½å£°äº¤è°ˆ..."           â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  ç‰¹ç‚¹ï¼š                                                     â”‚ â”‚
â”‚  â”‚  â€¢ åŠ¨æ€ç”Ÿæˆçš„æ–‡å­—æè¿°                                       â”‚ â”‚
â”‚  â”‚  â€¢ Demoç”¨é¢„è®¾ï¼Œæ­£å¼ç‰ˆç”¨LLM                                  â”‚ â”‚
â”‚  â”‚  â€¢ æ¯æ¬¡å¯èƒ½ä¸åŒï¼ˆåŸºäºä¸Šä¸‹æ–‡ï¼‰                               â”‚ â”‚
â”‚  â”‚  â€¢ æ¥æºï¼šLLM API / é¢„ç”Ÿæˆåº“                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ’¾ ç©å®¶çš„æ¸¸æˆå­˜æ¡£                             â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Cache Layer (è¿è¡Œæ—¶æ•°æ® - æ•°æ®åº“æ›¿èº«)           â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  æ–‡ä»¶ï¼š/engine/cache/InstanceCacheManager.ts               â”‚ â”‚
â”‚  â”‚  å®ç°ï¼šMap + localStorage (Demo) / Supabase (æ­£å¼ç‰ˆ)       â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  æ•°æ®ç¤ºä¾‹ï¼š                                                 â”‚ â”‚
â”‚  â”‚  StoryInstance:                                            â”‚ â”‚
â”‚  â”‚  {                                                         â”‚ â”‚
â”‚  â”‚    instance_id: 'story-hk-001__clue-001',                  â”‚ â”‚
â”‚  â”‚    player_id: 'player-xiaoming',  â† å°æ˜çš„æ•°æ®             â”‚ â”‚
â”‚  â”‚    story_template_id: 'story-hk-001',  â† å¼•ç”¨ä¸Šé¢çš„æ¨¡æ¿    â”‚ â”‚
â”‚  â”‚    status: 'in_progress',         â† å°æ˜æ­£åœ¨ç©             â”‚ â”‚
â”‚  â”‚    progress_percentage: 45,       â† å°æ˜çš„è¿›åº¦             â”‚ â”‚
â”‚  â”‚    current_scene_id: 'scene-b',   â† å°æ˜åœ¨åœºæ™¯B            â”‚ â”‚
â”‚  â”‚    completed_scenes: ['scene-a'], â† å°æ˜å®Œæˆäº†A            â”‚ â”‚
â”‚  â”‚    started_at: 1699234567890,     â† å°æ˜çš„å¼€å§‹æ—¶é—´         â”‚ â”‚
â”‚  â”‚    last_played_at: 1699234999999  â† å°æ˜æœ€åç©çš„æ—¶é—´       â”‚ â”‚
â”‚  â”‚  }                                                         â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  LLMSceneNarrativeRecord:                                  â”‚ â”‚
â”‚  â”‚  {                                                         â”‚ â”‚
â”‚  â”‚    scene_instance_id: 'story-001__clue-1__scene-a',       â”‚ â”‚
â”‚  â”‚    narrative_text: "ä½ æ¨å¼€é—¨...",  â† AIç”Ÿæˆçš„å†…å®¹ä¿å­˜     â”‚ â”‚
â”‚  â”‚    generated_at: 1699234567890,                            â”‚ â”‚
â”‚  â”‚    llm_model: 'gpt-4'             â† è®°å½•ç”Ÿæˆæ–¹å¼           â”‚ â”‚
â”‚  â”‚  }                                                         â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  ç‰¹ç‚¹ï¼š                                                     â”‚ â”‚
â”‚  â”‚  â€¢ ç©å®¶ä¸“å±æ•°æ®                                            â”‚ â”‚
â”‚  â”‚  â€¢ éšæ¸¸æˆè¿›è¡Œä¸æ–­æ›´æ–°                                       â”‚ â”‚
â”‚  â”‚  â€¢ åŒ…å«æ¸¸æˆçŠ¶æ€å’ŒAIç”Ÿæˆå†…å®¹                                â”‚ â”‚
â”‚  â”‚  â€¢ å­˜å‚¨ï¼šlocalStorage / Database                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **å…·ä½“å¯¹æ¯”è¡¨**

| ç»´åº¦ | Data Access | Service Mock Data | Cache |
|---|---|---|---|
| **æ•°æ®æ€§è´¨** | æ¸¸æˆé…ç½®ï¼ˆé™æ€ï¼‰ | AIç”Ÿæˆå†…å®¹ï¼ˆåŠ¨æ€ï¼‰ | ç©å®¶æ•°æ®ï¼ˆè¿è¡Œæ—¶ï¼‰ |
| **ç¤ºä¾‹æ•°æ®** | `{ scene_id, title, npc_ids }` | `"ä½ æ¨å¼€é—¨..."` | `{ status, progress, ... }` |
| **æ˜¯å¦å…±äº«** | âœ… æ‰€æœ‰ç©å®¶å…±äº« | âŒ åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆ | âŒ æ¯ä¸ªç©å®¶ç‹¬ç«‹ |
| **æ˜¯å¦å˜åŒ–** | âŒ æ¸¸æˆæ›´æ–°æ‰å˜ | âœ… æ¯æ¬¡å¯èƒ½ä¸åŒ | âœ… ä¸æ–­æ›´æ–° |
| **æ•°æ®é‡** | ä¸­ç­‰ï¼ˆå‡ ç™¾ä¸ªåœºæ™¯ï¼‰ | å¤§ï¼ˆæ¯ä¸ªç©å®¶æ¯æ¬¡ç”Ÿæˆï¼‰ | å¤§ï¼ˆæ‰€æœ‰ç©å®¶çš„æ‰€æœ‰çŠ¶æ€ï¼‰ |
| **Demoæ¥æº** | JSONæ–‡ä»¶ | é¢„è®¾æ–‡æœ¬ | localStorage |
| **æ­£å¼ç‰ˆæ¥æº** | CMS / æ•°æ®åº“ | LLM API | Supabase |
| **è¯»å–é¢‘ç‡** | ä½ï¼ˆåˆ›å»ºå®ä¾‹æ—¶ï¼‰ | ä¸­ï¼ˆè¿›å…¥åœºæ™¯/å¯¹è¯æ—¶ï¼‰ | é«˜ï¼ˆæ¯æ¬¡çŠ¶æ€æ›´æ–°ï¼‰ |
| **ç¤ºä¾‹æ–‡ä»¶** | `demo-story-map.data.ts` | `MockDataProvider.ts` | `InstanceCacheManager.ts` |

---

## ğŸ”„ **å®Œæ•´äº¤äº’æµç¨‹**

### **åœºæ™¯ 1ï¼šç©å®¶ç¬¬ä¸€æ¬¡è¿½è¸ªçº¿ç´¢**

```typescript
// 1ï¸âƒ£ ç”¨æˆ·ç‚¹å‡»"è¿½è¸ªçº¿ç´¢"
<Button onClick={() => trackClue('clue-001')}>è¿½è¸ª</Button>

// ============================================
// 2ï¸âƒ£ ä» Data Access è¯»å–æ•…äº‹æ¨¡æ¿
// ============================================
const storyDataAccess = DataAccessFactory.createStoryDataAccess();
const storyTemplate = await storyDataAccess.getStoryById('story-hk-001');

// è¿”å›ï¼ˆData Accessï¼‰ï¼š
{
  meta: {
    story_id: 'story-hk-001',
    title: 'éœ“è™¹è¿·é›¾',
    scenes: ['scene-a', 'scene-b', 'scene-c']
  },
  scenes: {
    'scene-a': { title: 'èµ›åšé…’å§', npc_ids: [...] },
    'scene-b': { title: 'åºŸå¼ƒå·¥å‚', ... }
  }
}

// ============================================
// 3ï¸âƒ£ åˆ›å»ºç©å®¶ä¸“å±çš„æ•…äº‹å®ä¾‹ï¼ˆå†™å…¥ Cacheï¼‰
// ============================================
InstanceCacheManager.createStoryInstance(playerId, clueId, storyTemplate);

// å†™å…¥ Cacheï¼ˆlocalStorageï¼‰ï¼š
{
  instance_id: 'story-hk-001__clue-001',
  player_id: 'player-xiaoming',
  story_template_id: 'story-hk-001',  // â† å¼•ç”¨æ¨¡æ¿
  status: 'not_started',              // â† ç©å®¶çŠ¶æ€
  progress_percentage: 0,
  current_scene_id: null,
  scene_sequence: ['scene-a', 'scene-b', 'scene-c']  // â† ä»æ¨¡æ¿å¤åˆ¶
}

// âœ… ç»“æœï¼šå°æ˜ç°åœ¨æœ‰äº†è‡ªå·±çš„æ•…äº‹å‰¯æœ¬
```

---

### **åœºæ™¯ 2ï¼šç©å®¶è¿›å…¥åœºæ™¯**

```typescript
// 1ï¸âƒ£ ç”¨æˆ·ç‚¹å‡»"è¿›å…¥æ•…äº‹"
StoryService.startStory(storyInstanceId);
StoryService.enterScene(storyInstanceId, 'scene-a');

// ============================================
// 2ï¸âƒ£ ä» Data Access è¯»å–åœºæ™¯æ¨¡æ¿
// ============================================
const sceneTemplate = await storyDataAccess.getSceneById('story-hk-001', 'scene-a');

// è¿”å›ï¼ˆData Accessï¼‰ï¼š
{
  scene_id: 'scene-a',
  title: 'èµ›åšé…’å§ - æš—å½±ä¹‹ä¸‹',
  location: 'ç¬¬ä¸ƒåŒºåœ°ä¸‹é…’å§',
  time_of_day: 'æ·±å¤œ23:47',
  present_npc_ids: ['npc-broker', 'npc-bartender']
}

// ============================================
// 3ï¸âƒ£ åˆ›å»ºåœºæ™¯å®ä¾‹ï¼ˆå†™å…¥ Cacheï¼‰
// ============================================
InstanceCacheManager.createSceneInstance(storyInstanceId, sceneTemplate);

// å†™å…¥ Cacheï¼š
{
  instance_id: 'story-001__clue-1__scene-a',
  scene_template_id: 'scene-a',
  status: 'in_progress',
  entered_at: 1699234567890,
  triggered_events: []
}

// ============================================
// 4ï¸âƒ£ ä½¿ç”¨ Service Mock Data ç”Ÿæˆå™äº‹
// ============================================
const narrative = MockSceneProvider.generateSceneNarrative('scene-a');

// è¿”å›ï¼ˆService Mock Data - Demoé˜¶æ®µï¼‰ï¼š
"ä½ æ¨å¼€åšé‡çš„é‡‘å±é—¨ï¼Œèµ°è¿›è¿™ä¸ªè¢«éœ“è™¹ç¯ç…§äº®çš„åœ°ä¸‹ä¸–ç•Œã€‚
é…’å§é‡ŒçƒŸé›¾ç¼­ç»•ï¼Œå…¨æ¯æŠ•å½±åœ¨ç©ºæ°”ä¸­æ‰­æ›²å˜å½¢..."

// æ­£å¼ç‰ˆä¼šè°ƒç”¨ï¼š
// const narrative = await LLM.generate({
//   template: sceneTemplate,
//   playerHistory: getPlayerHistory(playerId),
//   storyContext: getCurrentStoryContext()
// });

// ============================================
// 5ï¸âƒ£ ä¿å­˜ç”Ÿæˆçš„å™äº‹ï¼ˆå†™å…¥ Cacheï¼‰
// ============================================
InstanceCacheManager.saveLLMSceneNarrative({
  record_id: 'narrative_001',
  scene_instance_id: 'story-001__clue-1__scene-a',
  narrative_text: narrative,  // â† AIç”Ÿæˆçš„å†…å®¹
  generated_at: 1699234567890,
  llm_model: 'mock-gpt-4'
});

// âœ… ç»“æœï¼š
// - Data Access æä¾›äº†åœºæ™¯ç»“æ„ï¼ˆé™æ€ï¼‰
// - Service Mock ç”Ÿæˆäº†æè¿°æ–‡å­—ï¼ˆåŠ¨æ€ï¼‰
// - Cache ä¿å­˜äº†ç©å®¶çš„è¿›åº¦å’ŒAIå†…å®¹ï¼ˆè¿è¡Œæ—¶ï¼‰
```

---

### **åœºæ™¯ 3ï¼šç©å®¶ä¸ NPC å¯¹è¯**

```typescript
// 1ï¸âƒ£ ç”¨æˆ·è¾“å…¥å¯¹è¯
<Input onSubmit={(text) => sendMessage('npc-broker', text)} />
// ç”¨æˆ·è¾“å…¥ï¼š"ä½ çŸ¥é“å¤±è¸ªæ¡ˆçš„çº¿ç´¢å—ï¼Ÿ"

// ============================================
// 2ï¸âƒ£ ä» Cache è¯»å– NPC å®ä¾‹ï¼ˆè¿è¡Œæ—¶çŠ¶æ€ï¼‰
// ============================================
const npcInstance = InstanceCacheManager.getNPCInstance(npcInstanceId);

// è¿”å›ï¼ˆCacheï¼‰ï¼š
{
  instance_id: 'story-001__clue-1__npc-broker',
  npc_template_id: 'npc-broker',
  current_state: {
    relationship: 30,         // â† å½“å‰å…³ç³»å€¼
    current_mood: 'neutral',  // â† å½“å‰æƒ…ç»ª
    trust_level: 30
  }
}

// ============================================
// 3ï¸âƒ£ ä½¿ç”¨ Service Mock Data ç”Ÿæˆå¯¹è¯
// ============================================
const response = MockNPCProvider.generateNPCDialogue(
  'npc-broker',
  'ä½ çŸ¥é“å¤±è¸ªæ¡ˆçš„çº¿ç´¢å—ï¼Ÿ',
  { npcState: npcInstance.current_state }
);

// è¿”å›ï¼ˆService Mock Data - Demoé˜¶æ®µï¼‰ï¼š
"æœ‰è¶£çš„é—®é¢˜..."é›¶å·æŠ¬èµ·å¤´ï¼Œå¢å¼ºçœ¼é•œä¸‹çš„åŒçœ¼é—ªçƒç€æ•°æ®æµçš„å…‰èŠ’ã€‚
"æ•°æ®æ˜¾ç¤º...å—¯ï¼Œè¿™æ¯”æˆ‘æƒ³è±¡çš„è¦å¤æ‚ã€‚ä½ ç¡®å®šè¦çŸ¥é“ï¼Ÿ""

// æ­£å¼ç‰ˆä¼šè°ƒç”¨ï¼š
// const response = await LLM.generateDialogue({
//   npcProfile: npcTemplate,
//   npcState: npcInstance.current_state,
//   playerInput: 'ä½ çŸ¥é“å¤±è¸ªæ¡ˆçš„çº¿ç´¢å—ï¼Ÿ',
//   conversationHistory: getDialogueHistory(npcInstanceId)
// });

// ============================================
// 4ï¸âƒ£ ä¿å­˜å¯¹è¯è®°å½•ï¼ˆå†™å…¥ Cacheï¼‰
// ============================================
InstanceCacheManager.saveLLMDialogue({
  record_id: 'dialogue_001',
  npc_instance_id: npcInstanceId,
  player_input: 'ä½ çŸ¥é“å¤±è¸ªæ¡ˆçš„çº¿ç´¢å—ï¼Ÿ',
  npc_response: response,
  turn_number: 1,
  created_at: 1699234567890
});

// ============================================
// 5ï¸âƒ£ æ›´æ–° NPC çŠ¶æ€ï¼ˆå†™å…¥ Cacheï¼‰
// ============================================
InstanceCacheManager.updateNPCInstance(npcInstanceId, {
  relationship: 35  // â† å…³ç³»å€¼ +5
});

// âœ… ç»“æœï¼š
// - Service Mock ç”Ÿæˆäº†å¯¹è¯ï¼ˆæ¨¡æ‹ŸLLMï¼‰
// - Cache ä¿å­˜äº†å¯¹è¯å†å²å’ŒNPCçŠ¶æ€å˜åŒ–
```

---

## ğŸ’¡ **ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸‰å±‚ï¼Ÿ**

### **1. Data Access Layerï¼ˆä¸ºä»€ä¹ˆä¸èƒ½å°‘ï¼Ÿï¼‰**

```
âŒ æ²¡æœ‰ Data Access çš„é—®é¢˜ï¼š
- æ¯æ¬¡åˆ›å»ºæ•…äº‹å®ä¾‹éƒ½è¦ç¡¬ç¼–ç åœºæ™¯åˆ—è¡¨
- æ— æ³•ç»Ÿä¸€ç®¡ç†æ¸¸æˆé…ç½®
- æ¸¸æˆæ›´æ–°éœ€è¦æ”¹ä»£ç 

âœ… æœ‰ Data Access çš„å¥½å¤„ï¼š
- æ¸¸æˆè®¾è®¡å¸ˆå¯ä»¥åœ¨ JSON/CMS ä¸­ç¼–è¾‘å†…å®¹
- æ‰€æœ‰ç©å®¶ä½¿ç”¨ç»Ÿä¸€çš„æ¸¸æˆé…ç½®
- Demo å’Œæ­£å¼ç‰ˆåªéœ€åˆ‡æ¢æ•°æ®æº
```

---

### **2. Service Mock Dataï¼ˆä¸ºä»€ä¹ˆä¸èƒ½å°‘ï¼Ÿï¼‰**

```
âŒ æ²¡æœ‰ Service Mock çš„é—®é¢˜ï¼š
- Demo é˜¶æ®µæ— æ³•è¿è¡Œï¼ˆå¿…é¡»ç­‰ LLM APIï¼‰
- æ— æ³•å¿«é€Ÿæµ‹è¯•æ¸¸æˆé€»è¾‘
- LLM æˆæœ¬é«˜æ˜‚

âœ… æœ‰ Service Mock çš„å¥½å¤„ï¼š
- Demo é˜¶æ®µç”¨é¢„è®¾æ–‡æœ¬
- æ­£å¼ç‰ˆæ— ç¼åˆ‡æ¢åˆ° LLM
- å¯ä»¥æ··åˆä½¿ç”¨ï¼ˆéƒ¨åˆ†é¢„ç”Ÿæˆ + éƒ¨åˆ†åŠ¨æ€ç”Ÿæˆï¼‰
```

---

### **3. Cache Layerï¼ˆä¸ºä»€ä¹ˆä¸èƒ½å°‘ï¼Ÿï¼‰**

```
âŒ æ²¡æœ‰ Cache çš„é—®é¢˜ï¼š
- æ— æ³•ä¿å­˜ç©å®¶è¿›åº¦
- åˆ·æ–°é¡µé¢æ¸¸æˆé‡ç½®
- æ— æ³•è¿½æº¯ç©å®¶å†å²

âœ… æœ‰ Cache çš„å¥½å¤„ï¼š
- ç©å®¶è¿›åº¦æŒä¹…åŒ–
- æ‰€æœ‰çŠ¶æ€å˜åŒ–éƒ½è®°å½•
- Demo ç”¨ localStorageï¼Œæ­£å¼ç‰ˆç”¨æ•°æ®åº“
```

---

## âœ… **æ€»ç»“**

```
ä¸‰å±‚æ•°æ®çš„æœ¬è´¨ï¼š

Data Access    =  æ¸¸æˆè®¾è®¡çš„è“å›¾  ï¼ˆæ‰€æœ‰ç©å®¶å…±äº«ï¼‰
Service Mock   =  AI ç”Ÿæˆçš„å‰§æœ¬   ï¼ˆåŸºäºè“å›¾å’Œç©å®¶è¡Œä¸ºï¼‰
Cache          =  ç©å®¶çš„å­˜æ¡£     ï¼ˆæ¯ä¸ªç©å®¶ç‹¬ç«‹ï¼‰

ä¸‰è€…ç¼ºä¸€ä¸å¯ï¼Œå„å¸å…¶èŒï¼
```

**æ¯”å–»è¯´æ˜ï¼š**

- **Data Access** = å‰§æœ¬å¤§çº²ï¼ˆå¯¼æ¼”å†™çš„ï¼Œæ¼”å‘˜ç…§ç€æ¼”ï¼‰
- **Service Mock** = æ¼”å‘˜çš„å³å…´å‘æŒ¥ï¼ˆåŸºäºå‰§æœ¬å¤§çº² + ç°åœºæƒ…å†µï¼‰
- **Cache** = æ‹æ‘„è®°å½•ï¼ˆæ¯åœºæˆçš„å®é™…è¡¨ç°ï¼Œä¿å­˜ä¸‹æ¥ï¼‰

**æŠ€æœ¯å¯¹åº”ï¼š**

| å±‚ | Demo å®ç° | æ­£å¼ç‰ˆå®ç° |
|---|---|---|
| Data Access | JSON æ–‡ä»¶ | CMS / Supabase è¡¨ |
| Service Mock | é¢„è®¾æ–‡æœ¬ | LLM API (GPT-4) |
| Cache | localStorage | Supabase è¡¨ |
